#!/usr/bin/env bash
cd /
ssh -o StrictHostKeyChecking=no -i /etc/keepalived/openlab.pem "ubuntu@{{ nodepool_master_ip }}" "
        set -x
        sudo systemctl stop nodepool-* --all
    "

ssh -o StrictHostKeyChecking=no -i /etc/keepalived/openlab.pem "ubuntu@{{ zuul_master_ip }}" "
        set -x
        sudo systemctl stop gearman-job-server
        sudo systemctl stop statsd
        sudo systemctl stop zuul-* --all
        sudo systemctl stop apache2
    "

ssh -o StrictHostKeyChecking=no -i /etc/keepalived/openlab.pem "ubuntu@{{ nodepool_slave_ip }}" "
        set -x
        sudo systemctl start nodepool-* --all
    "

ssh -o StrictHostKeyChecking=no -i /etc/keepalived/openlab.pem "ubuntu@{{ zuul_slave_ip }}" "
        set -x
        sudo systemctl start gearman-job-server
        sudo systemctl start statsd
        sudo systemctl start zuul-* --all
        sudo systemctl start apache2
    "

# Get tools to change webhook or change the DNS record(Manually)
if [ ! -f "/etc/keepalived/cli.py" ];then
    wget -P /etc/keepalived/  https://raw.githubusercontent.com/wangxiyuan/Toy/master/github-app-webhook-url-update-tool/cli.py
fi
python3 /etc/keepalived/cli.py --user {{ upstream_user }} --password {{ upstream_password }} --app {{ app_name }} --ip {{ zuul_slave_ip }}

# For now, if a deployment is Down, we need to notify to upstream through a Github Issue
python /etc/keepalived/notify_upstream.py --username {{ upstream_user }} --password {{ upstream_password }} --env-role {{ ori_env_role }}
